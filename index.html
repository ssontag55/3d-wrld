<!DOCTYPE HTML>
<html>
  <head>
    <script src="https://unpkg.com/wrld.js@1.x.x"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css" rel="stylesheet" />

    <link href="https://cdn-webgl.wrld3d.com/wrldjs/addons/resources/v1/latest/css/wrld.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
    <script src="https://cdn-webgl.wrld3d.com/wrldjs/addons/indoor_control/v1/latest/indoor_control.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <title>TerraBase 3D</title>
  </head>
  <style>
    #map { height: calc(98% - 29px);width: 99%; position: fixed;}
    .loading-screen {
      position: absolute;
      right: 0px;
      left: 0px;
      top: 20px;
      display: none;
      bottom: 0px;
      color:  white;
      z-index: 150;
      background-color: none;
      height: 400px;
    }

  .hidden {
    visibility: hidden;
  }
  h4 {
    margin: 2px !important;
  }
  .loading-text {
    display: flex;
    text-align: center;
    justify-content: center;
    align-items: center;
    height: inherit;
    font-family: amsibold,'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;
  }

  .wrld-widget-container {
    height: 380px;
    top: 20px !important;
  }
  .eegeo-indoor-control {
    height:  380px;
  }
  .eegeo-indoor-control {
    height: 380px;
  }
  .eegeo-floor-slider {
    height: 314px;
  }
  .eegeo-indoor-control #eegeo-exit-interior-button-container { 
    visibility: hidden;
  }
</style>
  <body>
      <div style="position: relative;height: 100%;margin-top:-20px">
      <div id="loading-screen" class="loading-screen">
        <div class="loading-text">Loading...</div>
      </div>
      <div id="topRightButtons" style="float:right">
        <button type="button" onclick="map.indoors.exit()">Exit Indoor Map</button>
      </div>
      <div style="width: 200px;position: absolute;">
        <h4>Another Course To College</h4>
      </div>
      <div style="width: 200px;margin-left: 240px;">
        <h6>(Right Click to rotate)</h6>
      </div>
      <div id="widget-container" class="wrld-widget-container"></div>
      <div id="map"></div>
      <script>

      var map = Wrld.map("map", "5b3e8893f829b06ab7b2e619a9bdd506", {
        center: [42.2652301500322,-71.1174400998413],
        indoorsEnabled: true,
        //drawClearColor: "#3d4447",
        zoom: 17,
        trafficEnabled: false,
        frameRateThrottleWhenIdleEnabled: true,
        throttledTargetFrameIntervalMilliseconds: 500,
        idleSecondsBeforeFrameRateThrottle: 15.0,
        coverageTreeManifest: "https://webgl-cdn1.wrld3d.com/chunk/indoor_maps/api_requests/EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b_2022_01_25_19_43_44/webgl_manifest.bin.gz"
        //indoorMapBackgroundColor: "#3d4447"
      });

      $.get('sensors.csv', function(csvString) {

        // Use PapaParse to convert string to array of objects
        var data = Papa.parse(csvString, {header: true, dynamicTyping: true}).data;
        for (var i in data) {
          var row = data[i];

          if(row.Latitude && row.Longitude) {
            // add INDOOR marker
            var marker = Wrld.circle([row.Latitude, row.Longitude], {
              indoorMapId: "EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b",
              indoorMapFloorId: row.Floor,
              opacity: 1,
              color: '#32a852',
              radius: 1.0
            }).bindPopup(row.SensorName);
            
            marker.addTo(map);

            // add map marker
            var markerMainMap = Wrld.circle([row.Latitude, row.Longitude], {
              //indoorMapId: "EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b",
              //indoorMapFloorId: row.Floor,
              opacity: 1,
              color: '#34a4eb',
              radius: 1.0
            }).bindPopup(row.SensorName);
            
            markerMainMap.addTo(map);
          }
        }
      });

      var indoorControl = new WrldIndoorControl("widget-container", map);
      var isShowingLoadingScreen = true;

      setLoadingScreenVisibility(isShowingLoadingScreen);

      function onIndoorMapEntered(event) {
        if (isShowingLoadingScreen) {
          if (currentIndoorMap in indoorMapLoaded && indoorMapLoaded[currentIndoorMap]) {
            setLoadingScreenVisibility(false);
          }
          else {
            indoorMapLoaded[currentIndoorMap] = true;
            setTimeout(() => {
              setLoadingScreenVisibility(false);
            }, 500);
          }
        }
      }

      function entityIdsInRange(from,to) {
        var ids = [];
        for(var i = from; i<=to; i++ ){
          var id = (i+"").padStart(4,"0");
          ids.push(id);
        }
        return ids;
      }

      function entityHeatColor(heat){
        var lightness = (1.0 - heat)*255;
        var red = 255;
        return [red, lightness, lightness, 255];
      }

      function onInitialStreamingComplete() {
        map.indoors.enter("EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b");
        Wrld.indoorMapEntities.indoorMapEntityInformation("EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b").addTo(map);
        /*Wrld.indoorMapFloorOutlines
          .indoorMapFloorOutlineInformation("EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b", 2)
          .addTo(map);*/
        // map.indoors.setEntityHighlights(entityIdsInRange(10,50), entityHeatColor(0.0));
        //map.indoors.setEntityHighlights(["10","11","12","13"], [255, 0, 0, 128],"EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b" ,1); 
        
        //, "EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b"
        //map.indoors.enter("westport_house");
        //enterCurrentIndoorMap();
      }

      function setLoadingScreenVisibility(visible) {
        var className = visible ? "loading-screen" : "loading-screen hidden";
        var loadingScreen = document.getElementById("loading-screen");
        loadingScreen.className = className;
        isShowingLoadingScreen = visible;
      }

      function enterCurrentIndoorMap() {
        if (map.indoors.isIndoors()) {
          map.indoors.exit();
        }
        map.indoors.enter(currentIndoorMap, {
          animate: true
        });
      }

      function onIndoorMapEnterFailed(event) {
        console.log("onIndoorMapEnterFailed");
      }

      function getLatestValuesForSchool(schoolID) {
        //https://dev-bostonschoolsiaq.terrabase.com/api/TerraSense/Sensor/LatestBySite/2061/5
      }
      
      function onIndoorMapEntityInformationChanged(event) {
        var indoorMapEntityInformation = event.indoorMapEntityInformation;
        var indoorMapId = indoorMapEntityInformation.getIndoorMapId();
        var loadState = indoorMapEntityInformation.getLoadState();

        var indoorMapEntities = indoorMapEntityInformation.getIndoorMapEntities();

        if (loadState !== "Complete") return;

        indoorMapEntities.forEach(function(entity) {
          addPolygon(entity, map, indoorMapEntityInformation);
        });

        map.indoors.setEntityHighlights(["2-37"], [255, 0, 0, 0.8], "EIM-8de91e7e-1f90-4c41-b0ee-6845c5029c3b");
        
        //var entitys = entityIdsInRange(1,250);
        /*for( var i = 0; i < entitys.length; i++ ){
          var  heat = i / entitys.length;
          console.log(heat);
          map.indoors.setEntityHighlights(entitys[i], entityHeatColor(heat));
        }*/
      }

      function addPolygon(entity, map, indoorMapEntityInformation) {
        const polygon = entity.getOutline();
        if (polygon.length === 0) return;
        const indoorMapId = indoorMapEntityInformation.getIndoorMapId();
        const indoorMapFloorId =  entity.getIndoorMapFloorId();
        const polygonOptions = { indoorMapId, indoorMapFloorId, interactive: false };

        Wrld.polygon(polygon, polygonOptions).addTo(map);
      }

      function onIndoormapFloorOutlineInformationLoaded(event) {
        var outlineInformation = event.indoorMapFloorOutlineInformation;

        var polygons = outlineInformation.getIndoorMapFloorOutlinePolygons();
        polygons.forEach(function(polygon) {
          var polygonOptions = {indoorMapId: outlineInformation.getIndoorMapId(),
                                indoorMapFloorId: outlineInformation.getIndoorMapFloorId()};
          var polyPoints = [];
          polyPoints.push(polygon.getOuterRing().getLatLngPoints());
          polygon.getInnerRings().forEach(function(innerRing){
            polyPoints.push(innerRing.getLatLngPoints());
          });
          
          Wrld.polygon(polyPoints, polygonOptions).addTo(map);
        });
      }

      map.indoorMapEntities.on("indoormapentityinformationchanged",onIndoorMapEntityInformationChanged);
      map.on("initialstreamingcomplete", onInitialStreamingComplete);
      map.indoors.on("indoormapenter", onInitialStreamingComplete);
      //map.indoors.on("indoormapenter", onIndoorMapEntered);
      map.indoors.on("indoormapenterfailed", onIndoorMapEnterFailed);
      map.indoorMapFloorOutlines.on("indoormapflooroutlineinformationloaded", onIndoormapFloorOutlineInformationLoaded);
    </script>
  </div>
  </body>
</html>